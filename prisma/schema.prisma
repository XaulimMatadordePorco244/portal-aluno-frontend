datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum Role {
  ALUNO
  ADMIN
}

enum TipoCargo {
  POSTO
  GRADUACAO
  CURSO
}

enum ClasseOficial {
  SUPERIOR
  INTERMEDIARIO
  SUBALTERNO
}

enum CategoriaCargo {
  FORMACAO
  QUADRO
}

enum StatusParte {
  RASCUNHO
  ENVIADA
  ANALISADA
  APROVADO
  REPROVADO
}

enum ResultadoAnalise {
  APROVADA
  NEGADA
  ARQUIVADA
  ENCAMINHADA
}

enum TipoProcesso {
  GENERICO
  TROCA_DE_ESCALA
  RECLAMACAO
  ATO_DE_BRAVURA
  RECONSIDERACAO_ATO_DE_BRAVURA
}

enum StatusEscala {
  RASCUNHO
  PUBLICADA
  FECHADA
  ARQUIVADA
}

enum TipoEscala {
  COLABORACAO
  ESPECIAL
  EVENTO
  PERSONALIZADO
  OUTRO
}

model User {
  id                   String    @id @default(cuid())
  cpf                  String    @unique
  password             String
  nome                 String
  numero               String?   @unique
  companhia            String?
  conceito             String?
  anoIngresso          Int?
  email                String?   @unique
  status               String    @default("Ativo")
  fotoUrl              String?
  validationId         String    @unique @default(cuid())
  nomeDeGuerra         String?
  cargoId              String?
  funcaoId             String?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  passwordResetToken   String?   @unique
  passwordResetExpires DateTime?

  partesCriadas      Parte[]
  analisesFeitas     Analise[]
  logsAtor           LogParte[]
  anotacoesRecebidas Anotacao[]      @relation("AnotacoesDoAluno")
  anotacoesFeitas    Anotacao[]      @relation("AnotacoesFeitasPeloAutor")
  funcao             Funcao?         @relation(fields: [funcaoId], references: [id])
  cargo              Cargo?          @relation(fields: [cargoId], references: [id])
  escalasCriadas     Escala[]        @relation("EscalasCriadas")
  escalasAtribuidas  EscalaItem[]    @relation("EscalasAtribuidas")
  qesCriados         QES[]
  role               Role            @default(ALUNO)
  etapasResponsavel  EtapaProcesso[]
}

model Regulamento {
  id         String  @id @default(cuid())
  titulo     String
  arquivoUrl String
  ativo      Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model TipoDeAnotacao {
  id                String  @id @default(cuid())
  titulo            String  @unique
  descricao         String  @db.Text
  pontos            Float?
  abertoCoordenacao Boolean @default(false)

  registros Anotacao[]
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
}

model Anotacao {
  id       String   @id @default(cuid())
  pontos   Float
  detalhes String?  @db.Text
  data     DateTime

  tipo   TipoDeAnotacao @relation(fields: [tipoId], references: [id])
  tipoId String

  aluno   User   @relation("AnotacoesDoAluno", fields: [alunoId], references: [id])
  alunoId String

  autor   User   @relation("AnotacoesFeitasPeloAutor", fields: [autorId], references: [id])
  autorId String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model QES {
  id         String   @id @default(cuid())
  titulo     String
  arquivoUrl String
  autorId    String
  autor      User     @relation(fields: [autorId], references: [id])
  dataInicio DateTime
  dataFim    DateTime

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Cargo {
  id          String         @id @default(cuid())
  nome        String         @unique
  abreviacao  String         @unique
  codigo      Int?
  categoria   CategoriaCargo
  tipo        TipoCargo
  precedencia Int            @unique
  classe      ClasseOficial?
  usuarios    User[]
  divisaUrl   String?
}

model Funcao {
  id       String @id @default(cuid())
  nome     String @unique
  usuarios User[]
}

model Parte {
  id              String          @id @default(cuid())
  assunto         String
  conteudo        String          @db.Text
  status          StatusParte     @default(RASCUNHO)
  numeroDocumento String?         @unique
  tipo            TipoProcesso    @default(GENERICO)
  etapas          EtapaProcesso[]

  autorId String
  autor   User   @relation(fields: [autorId], references: [id])

  analises Analise[]
  logs     LogParte[]

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  dataEnvio DateTime?
}

model Analise {
  id          String           @id @default(cuid())
  observacoes String?          @db.Text
  resultado   ResultadoAnalise

  parteId String
  parte   Parte  @relation(fields: [parteId], references: [id])

  analistaId String
  analista   User   @relation(fields: [analistaId], references: [id])

  createdAt DateTime @default(now())
}

model LogParte {
  id       String  @id @default(cuid())
  acao     String
  detalhes String?

  parteId String
  parte   Parte  @relation(fields: [parteId], references: [id])

  atorId String
  ator   User   @relation(fields: [atorId], references: [id])

  createdAt DateTime @default(now())
}

model Configuracao {
  id                String @id @default("singleton")
  ultimaParteNumero Int    @default(0)
}

model EtapaProcesso {
  id         String @id @default(cuid())
  processoId String
  processo   Parte  @relation(fields: [processoId], references: [id])

  titulo        String
  status        String
  responsavelId String?
  responsavel   User?   @relation(fields: [responsavelId], references: [id])

  conteudo      String?   @db.Text
  decisao       String?
  dataConclusao DateTime?

  createdAt DateTime @default(now())
}

model Escala {
  id           String       @id @default(cuid())
  dataEscala   DateTime     @db.Date
  tipo         TipoEscala
  status       StatusEscala @default(RASCUNHO)
  pdfUrl       String?
  elaboradoPor String

  criadoEm     DateTime  @default(now())
  atualizadoEm DateTime  @updatedAt
  publicadoEm  DateTime?

  itens       EscalaItem[]
  criadoPorId String
  criadoPor   User         @relation("EscalasCriadas", fields: [criadoPorId], references: [id])

  @@map("escalas")
}

model EscalaItem {
  id            String  @id @default(cuid())
  secao         String
  cargo         String
  horarioInicio String
  horarioFim    String
  observacao    String?

  escalaId String
  escala   Escala @relation(fields: [escalaId], references: [id], onDelete: Cascade)

  alunoId String
  aluno   User   @relation("EscalasAtribuidas", fields: [alunoId], references: [id])

  @@map("escala_itens")
}
