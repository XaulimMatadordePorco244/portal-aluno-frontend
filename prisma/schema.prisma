datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum Role {
  ALUNO
  ADMIN
  RESPONSAVEL
}

enum AptidaoFisicaStatus {
  LIBERADO
  LIBERADO_COM_RESTRICOES
  VETADO
}

enum TipoCargo {
  POSTO
  GRADUACAO
  CURSO
}

enum ClasseOficial {
  SUPERIOR
  INTERMEDIARIO
  SUBALTERNO
}

enum CategoriaCargo {
  FORMACAO
  QUADRO
}

enum StatusParte {
  RASCUNHO
  ENVIADA
  ANALISADA
  APROVADO
  REPROVADO
}

enum ResultadoAnalise {
  APROVADA
  NEGADA
  ARQUIVADA
  ENCAMINHADA
}

enum TipoProcesso {
  GENERICO
  TROCA_DE_ESCALA
  RECLAMACAO
  ATO_DE_BRAVURA
  RECONSIDERACAO_ATO_DE_BRAVURA
}

enum StatusEscala {
  RASCUNHO
  PUBLICADA
  FECHADA
  ARQUIVADA
}

enum TipoEscala {
  COLABORACAO
  ESPECIAL
  EVENTO
  PERSONALIZADO
  OUTRO
}

enum BandeiraTipo {
  BR
  MS
  NV
}

enum StatusUsuario {
  ATIVO
  INATIVO
  SUSPENSO
}

enum StatusEtapa {
  PENDENTE
  EM_ANALISE
  CONCLUIDA
}

enum GeneroUsuario {
  MASCULINO
  FEMININO
}

enum tipagemSanguinea {
  A_POSITIVO
  A_NEGATIVO
  B_POSITIVO
  B_NEGATIVO
  AB_POSITIVO
  AB_NEGATIVO
  O_POSITIVO
  O_NEGATIVO
}

model Usuario {
  id                   String  @id @default(cuid())
  cpf                  String  @unique @db.VarChar(11)
  password             String
  nome                 String
  email                String? @unique
  fotoUrl              String?
  validationId         String  @unique @default(cuid())
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  passwordResetToken   String? @unique
  passwordResetExpires DateTime?
  status               StatusUsuario @default(ATIVO)
  role                 Role

  rg                   String?
  rgEstadoEmissor      String?
  dataNascimento       DateTime? @db.Date
  telefone             String?
  genero               GeneroUsuario?

  partesCriadas      Parte[]
  informativosCriados Informativo[] @relation("InformativosCriados")
  analisesFeitas     Analise[]
  logsAtor           LogParte[]
  comunicacoesCriadas ComunicacaoInterna[] @relation("CIsCriadas")
  anotacoesFeitas    Anotacao[]         @relation("AnotacoesFeitasPeloAutor")
  escalasCriadas     Escala[]           @relation("EscalasCriadas")
  qesCriados         QES[]
  etapasResponsavel  EtapaProcesso[]

  perfilAluno        PerfilAluno?

  responsaveis       Responsabilidade[] @relation("Aluno")
  dependentes        Responsabilidade[] @relation("Responsavel")

  @@map("usuarios")
}

model PerfilAluno {
  id                   String   @id @default(cuid())
  usuarioId            String   @unique
  usuario              Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  numero               String? @unique
  conceito             String?
  anoIngresso          Int?
  nomeDeGuerra         String?

  tipagemSanguinea     tipagemSanguinea?
  aptidaoFisicaStatus  AptidaoFisicaStatus?
  aptidaoFisicaLaudo   Boolean  @default(false)
  aptidaoFisicaObs     String?  @db.Text
  escola               String?
  serieEscolar         String?
  endereco             String?  @db.Text
  termoResponsabilidadeAssinado Boolean @default(false)
  fazCursoExterno      Boolean  @default(false)
  cursoExternoDescricao String?  @db.Text

  cargoId              String?
  funcaoId             String?
  companhiaId          String?

  funcao               Funcao?         @relation(fields: [funcaoId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  cargo                Cargo?          @relation(fields: [cargoId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  companhia            Companhia?      @relation(fields: [companhiaId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  
  anotacoesRecebidas   Anotacao[]      @relation("AnotacoesDoAluno")
  escalasAtribuidas    EscalaItem[]    @relation("EscalasAtribuidas")

  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  
  @@index([cargoId])
  @@index([funcaoId])
  @@index([companhiaId])
  @@map("perfis_alunos")
}

model ComunicacaoInterna {
  id                String   @id @default(cuid())
  

  titulo            String  
  assunto           String   
  resumo            String?  @db.Text 
  
  
  arquivoUrl        String   
  nomeArquivoGerado String   
  

  anoReferencia     Int      
  numeroSequencial  Int      

  dataPublicacao    DateTime @default(now())
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt


  autorId           String
  autor             Usuario  @relation("CIsCriadas", fields: [autorId], references: [id], onDelete: Restrict)

  @@unique([anoReferencia, numeroSequencial]) 
  @@index([dataPublicacao])
  @@index([assunto])       
  @@map("comunicacoes_internas")
}

model Responsabilidade {
  id              String   @id @default(cuid())
  responsavelId   String
  alunoId         String
  
  responsavel     Usuario  @relation("Responsavel", fields: [responsavelId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  aluno           Usuario  @relation("Aluno", fields: [alunoId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  
  tipoParentesco  String?

  createdAt       DateTime @default(now())
  
  @@unique([responsavelId, alunoId])
  @@index([responsavelId])
  @@index([alunoId])
  @@map("responsabilidades")
}

model Companhia {
  id         String      @id @default(cuid())
  nome       String      @unique
  abreviacao String?     @unique
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
  
  alunos     PerfilAluno[]

  @@map("companhias")
}

model Regulamento {
  id         String   @id @default(cuid())
  titulo     String
  arquivoUrl String
  ativo      Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model TipoDeAnotacao {
  id                String     @id @default(cuid())
  titulo            String     @unique
  descricao         String     @db.Text
  pontos            Float?
  abertoCoordenacao Boolean    @default(false)
  registros         Anotacao[]
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt
}

model Anotacao {
  id        String   @id @default(cuid())
  pontos    Float
  detalhes  String?  @db.Text
  data      DateTime
  tipoId    String
  alunoId   String
  autorId   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tipo  TipoDeAnotacao @relation(fields: [tipoId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  aluno PerfilAluno    @relation("AnotacoesDoAluno", fields: [alunoId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  autor Usuario        @relation("AnotacoesFeitasPeloAutor", fields: [autorId], references: [id], onDelete: Restrict, onUpdate: Cascade)

  @@index([tipoId])
  @@index([alunoId])
  @@index([autorId])
}

model QES {
  id         String   @id @default(cuid())
  titulo     String
  arquivoUrl String
  autorId    String
  dataInicio DateTime
  dataFim    DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  
  autor Usuario @relation(fields: [autorId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  
  @@index([autorId])
}

model Cargo {
  id          String         @id @default(cuid())
  nome        String         @unique
  abreviacao  String         @unique
  codigo      Int?
  categoria   CategoriaCargo
  tipo        TipoCargo
  precedencia Int            @unique
  classe      ClasseOficial?
  divisaUrl   String?
  
  alunos      PerfilAluno[]
}

model Funcao {
  id        String      @id @default(cuid())
  nome      String      @unique
  categoria String?
  
  alunos    PerfilAluno[]
}

model Parte {
  id              String       @id @default(cuid())
  assunto         String
  conteudo        String       @db.Text
  status          StatusParte  @default(RASCUNHO)
  numeroDocumento String?      @unique
  tipo            TipoProcesso @default(GENERICO)
  autorId         String
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  dataEnvio       DateTime?

  etapas   EtapaProcesso[]
  autor    Usuario       @relation(fields: [autorId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  analises Analise[]
  logs     LogParte[]

  @@index([autorId])
}

model Analise {
  id          String           @id @default(cuid())
  observacoes String?          @db.Text
  resultado   ResultadoAnalise
  parteId     String
  analistaId  String
  createdAt   DateTime         @default(now())

  parte    Parte   @relation(fields: [parteId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  analista Usuario @relation(fields: [analistaId], references: [id], onDelete: Restrict, onUpdate: Cascade)

  @@index([parteId])
  @@index([analistaId])
}

model LogParte {
  id        String   @id @default(cuid())
  acao      String
  detalhes  String?
  parteId   String
  atorId    String
  createdAt DateTime @default(now())

  parte Parte   @relation(fields: [parteId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  ator  Usuario @relation(fields: [atorId], references: [id], onDelete: Restrict, onUpdate: Cascade)

  @@index([parteId])
  @@index([atorId])
}

model Configuracao {
  id                String @id @default("singleton")
  ultimaParteNumero Int    @default(0)
}

model EtapaProcesso {
  id            String      @id @default(cuid())
  processoId    String
  titulo        String
  status        StatusEtapa @default(PENDENTE)
  responsavelId String?
  conteudo      String?     @db.Text
  decisao       String?
  dataConclusao DateTime?
  createdAt     DateTime    @default(now())

  processo    Parte    @relation(fields: [processoId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  responsavel Usuario? @relation(fields: [responsavelId], references: [id], onDelete: SetNull, onUpdate: Cascade)

  @@index([processoId])
  @@index([responsavelId])
}

model Escala {
  id           String       @id @default(cuid())
  dataEscala   DateTime     @db.Date
  tipo         TipoEscala
  status       StatusEscala @default(RASCUNHO)
  pdfUrl       String?
  elaboradoPor String
  fardamento   String?      @db.Text
  observacoes  String?      @db.Text
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  publishedAt  DateTime?
  criadoPorId  String

  itens     EscalaItem[]
  criadoPor Usuario      @relation("EscalasCriadas", fields: [criadoPorId], references: [id], onDelete: Restrict, onUpdate: Cascade)

  @@index([criadoPorId])
  @@map("escalas")
}

model EscalaItem {
  id            String        @id @default(cuid())
  secao         String
  cargo         String
  horarioInicio String
  horarioFim    String
  observacao    String?
  bandeira      BandeiraTipo?
  escalaId      String
  alunoId       String

  escala Escala      @relation(fields: [escalaId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  aluno  PerfilAluno @relation("EscalasAtribuidas", fields: [alunoId], references: [id], onDelete: Restrict, onUpdate: Cascade)

  @@index([escalaId])
  @@index([alunoId])
  @@map("escala_itens")
}

model Informativo {
  id             String   @id @default(cuid())
  
  titulo         String
  descricao      String?  @db.Text 
  

  arquivoUrl     String?  
  nomeArquivo    String? 

  dataPublicacao DateTime @default(now())
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  autorId        String
  autor          Usuario  @relation("InformativosCriados", fields: [autorId], references: [id], onDelete: Restrict)

  @@index([dataPublicacao])
  @@map("informativos")
}